<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì PMERIT - Empowering Learning Through Innovation</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- (Inline styles omitted for brevity, but keep your current ones) -->
    <style>
        /* ... keep your current CSS ... */
    </style>
    <script>
    // EMERGENCY LOGIN & MODE SWITCHING
    window.emergencyLogin = function() {
        localStorage.setItem('pmerit_session', JSON.stringify({
            loggedIn: true, 
            email: 'demo@pmerit.com', 
            name: 'Demo User', 
            time: Date.now()
        }));
        window.location.href = 'dashboard.html';
    };
    let isAdminMode = false;
    function toggleMode() {
        isAdminMode = !isAdminMode;
        const body = document.body;
        const toggleBtn = document.querySelector('.mode-toggle');
        if (isAdminMode) {
            body.classList.add('admin-mode');
            toggleBtn.textContent = 'üéì Switch to Student Mode';
            if (typeof loadEmployees === 'function') loadEmployees();
        } else {
            body.classList.remove('admin-mode');
            toggleBtn.textContent = 'üõ°Ô∏è Switch to Admin Mode';
        }
    }
    const API_BASE = 'https://pmerit-employee-api.peoplemerit.workers.dev/api';
    </script>
</head>
<body>
    <button class="mode-toggle" onclick="toggleMode()">üõ°Ô∏è Switch to Admin Mode</button>
    <!-- ... Student interface ... -->
    <!-- ... Admin interface ... -->
    <!-- ... Modals ... -->
    <!-- Modular JavaScript Files for Student Interface -->
    <script src="js/main.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/components.js"></script>
    <script src="js/pmerit-diagnostic-bot.js"></script>
    <!-- Admin functionality integration below: -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const addEmployeeForm = document.getElementById('addEmployeeForm');
        if (addEmployeeForm) {
            addEmployeeForm.addEventListener('submit', handleAddEmployee);
        }
    });

    async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (i < retries - 1) {
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                } else {
                    console.error('API call failed after multiple retries:', error);
                    throw error;
                }
            }
        }
    }
    function showAdminTab(tabName, tabElement) {
        const tabContents = document.querySelectorAll('.admin-tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        const tabs = document.querySelectorAll('.admin-tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        const targetTab = document.getElementById(tabName);
        if (targetTab) targetTab.classList.add('active');
        if (tabElement) tabElement.classList.add('active');
        if (tabName === 'admin-employees') loadEmployees();
    }
    function showCustomAlert(message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content">
                <h3>Notification</h3>
                <p>${message}</p>
                <div class="form-actions">
                    <button class="btn-cancel" onclick="this.closest('.modal').remove()">OK</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    function adminLogout() {
        showCustomAlert('Admin logged out! Switching to student mode...');
        setTimeout(() => { toggleMode(); }, 1500);
    }
    async function loadEmployees() {
        const employeeList = document.getElementById('employee-list');
        if (!employeeList) return;
        employeeList.innerHTML = '<div class="loading">Loading employees...</div>';
        try {
            const response = await fetchWithRetry(`${API_BASE}/employees`);
            const data = await response.json();
            const employees = data.employees || [];
            renderEmployees(employees);
        } catch (error) {
            console.error('Error loading employees:', error);
            employeeList.innerHTML = '<div class="no-employees"><p>Failed to load employees. Please try again.</p></div>';
        }
    }
    function renderEmployees(employees) {
        const employeeList = document.getElementById('employee-list');
        if (!employeeList) return;
        employeeList.innerHTML = '';
        if (employees.length === 0) {
            employeeList.innerHTML = '<div class="no-employees"><p>No employees found. Click "+ Add Employee" to get started.</p></div>';
            return;
        }
        employees.forEach(employee => {
            // Defensive defaults
            const status = (employee.status || 'PENDING').toUpperCase();
            const statusClass = status === 'ACTIVE' ? 'status-active' : 'status-pending';
            const employeeCard = document.createElement('div');
            employeeCard.className = 'employee-card';
            employeeCard.innerHTML = `
                <div class="employee-info">
                    <h3>${employee.fullName || employee.name || 'Unnamed'}</h3>
                    <p><strong>Email:</strong> ${employee.email || 'N/A'}</p>
                    <p><strong>Department:</strong> ${employee.department || 'N/A'}</p>
                    <p><strong>Role:</strong> ${employee.role || 'N/A'}</p>
                    <p><strong>Specialization:</strong> ${employee.specialization || 'General'}</p>
                </div>
                <div class="employee-actions">
                    <span class="status-badge ${statusClass}">${status}</span>
                    ${status === 'PENDING' ? `<button class="resend-btn" onclick="resendInvitation('${employee.id}')" aria-label="Resend Invitation for ${employee.fullName || employee.name}">Resend</button>` : ''}
                    <button class="remove-btn" onclick="showRemoveEmployeeModal('${employee.id}', '${employee.fullName || employee.name}')" aria-label="Remove Employee ${employee.fullName || employee.name}">üóëÔ∏è Remove</button>
                </div>
            `;
            employeeList.appendChild(employeeCard);
        });
    }
    function showAddEmployeeModal() {
        const modal = document.getElementById('addEmployeeModal');
        if (modal) modal.style.display = 'flex';
    }
    function closeAddEmployeeModal() {
        const modal = document.getElementById('addEmployeeModal');
        if (modal) modal.style.display = 'none';
    }
    function showRemoveEmployeeModal(employeeId, employeeName) {
        const modal = document.getElementById('removeEmployeeModal');
        const nameElement = document.getElementById('removeEmployeeName');
        if (modal && nameElement) {
            nameElement.textContent = employeeName;
            modal.dataset.employeeId = employeeId;
            modal.style.display = 'flex';
        }
    }
    function closeRemoveEmployeeModal() {
        const modal = document.getElementById('removeEmployeeModal');
        if (modal) modal.style.display = 'none';
    }
    function resendInvitation(employeeId) {
        showCustomAlert(`Invitation resent to employee ID: ${employeeId}. They will receive a new email with Tier 2 access instructions.`);
        // TODO: connect to backend for real invitation resending
    }
    // Add Employee Handler
    async function handleAddEmployee(event) {
        event.preventDefault();
        const form = event.target;
        const fullName = form.fullName.value.trim();
        const email = form.email.value.trim();
        const department = form.department.value;
        const role = form.role.value.trim();
        if (!fullName || !email || !department || !role) {
            showCustomAlert("Please fill in all required fields.");
            return;
        }
        try {
            const response = await fetchWithRetry(`${API_BASE}/employees`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ fullName, email, department, role })
            });
            const data = await response.json();
            if (data.success) {
                showCustomAlert("Employee added and invitation sent!");
                closeAddEmployeeModal();
                await loadEmployees(); // always reload after add
            } else {
                showCustomAlert(data.error || "Failed to add employee.");
            }
        } catch (error) {
            showCustomAlert("Failed to add employee. Please try again.");
        }
    }
    // Remove Employee Handler
    async function confirmRemoveEmployee() {
        const modal = document.getElementById('removeEmployeeModal');
        if (!modal || !modal.dataset.employeeId) return;
        const employeeId = modal.dataset.employeeId;
        try {
            const response = await fetchWithRetry(`${API_BASE}/employees/${employeeId}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                showCustomAlert("Employee removed.");
                closeRemoveEmployeeModal();
                await loadEmployees();
            } else {
                showCustomAlert(data.error || "Failed to remove employee.");
            }
        } catch (error) {
            showCustomAlert("Failed to remove employee. Please try again.");
        }
    }
    </script>
</body>
</html>
